<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="/spring2025/assets/images/favicon.ico" type="image/x-icon">
<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<title>Intro to SQLAlchemy</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css
">
<link rel="stylesheet" href="/spring2025/assets/main.css">

<!-- <script defer src="/spring2025/assets/js/fish-pond.js"></script> -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-163192686-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-163192686-1');
</script>
    </head>
    <body class="two-column">
        <!-- banner -->
<header>
    <section>
        <h1 class="desktop"><a href="/spring2025/">CSCI 344: Spring 2025</a></h1>
        <h2 class="desktop">Advanced Web Technology</h2>
        <a class="mobile" href="#" title="Toggle Menu">
            <i class="menu-toggle fas fa-bars"></i>
        </a>
        <h1 class="mobile">CSCI 344: Spring 2025</h1>
    </section>
    <img src="https://communication.unca.edu/wp-content/themes/tin/assets/logo.svg" alt="UNCA Logo" />
    <!-- <p class="kudos">
        Fish by <a href="https://github.com/akeatk/fish-pond" target="_blank">@akeatk</a>
    </p> -->
    <!-- <canvas></canvas> -->
</header>

        <nav>
    <ul>
        <li ><a href="/spring2025/syllabus/">Syllabus</a>
        </li>
        <li ><a
                href="/spring2025/">Schedule</a></li>
        <li ><a
                href="/spring2025/assignments/">Assignments</a></li>
        <li ><a href="/spring2025/resources/">Web
                Reference</a></li>
        <li><a href="https://drive.google.com/drive/folders/11Ra-DrGJOYMOC6Ag_3GS6ShxZFCPdKh6?usp=sharing"
                target="_blank">Lecture Recordings</a></li>
    </ul>
</nav>
        <main>
            <aside>
                <ol class="side-menu">
  <li><a href="#set-up-todays-exercises">Set Up Today’s Exercises</a>
    <ol>
      <li><a href="#what-just-happened">What just happened?</a></li>
    </ol>
  </li>
  <li><a href="#what-is-an-object-relational-mapping-orm">What is an Object Relational Mapping (ORM)?</a>
    <ol>
      <li><a href="#post-model">Post Model</a></li>
      <li><a href="#post-table">Post Table</a></li>
      <li><a href="#tips-for-following-along">Tips for following along</a></li>
    </ol>
  </li>
  <li><a href="#1-create-new-objects">1. Create New Objects</a>
    <ol>
      <li><a href="#sql">SQL</a></li>
      <li><a href="#flask-sqlalchemy">Flask SQLAlchemy</a></li>
    </ol>
  </li>
  <li><a href="#2-simple-queries">2. Simple Queries</a>
    <ol>
      <li><a href="#retrieve-all-posts">Retrieve all posts</a></li>
      <li><a href="#retrieve-the-first-10-posts">Retrieve the first 10 posts</a></li>
      <li><a href="#retrieve-all-the-posts-created-by-user-5">Retrieve all the posts created by user #5</a></li>
      <li><a href="#retrieve-all-the-posts-created-by-user-with-a-username-of-chad_marks">Retrieve all the posts created by user with a username of “chad_marks”</a></li>
      <li><a href="#retrieve-a-single-post-with-id--5">Retrieve a single post with id = 5</a></li>
      <li><a href="#other-cool-stuff-you-can-do-wsqlalchemy">Other cool stuff you can do w/SQLAlchemy</a></li>
    </ol>
  </li>
  <li><a href="#3-advanced-queries-with-regular-sqlalchemy">3. Advanced Queries with <span class="emphasize">REGULAR</span> SQLAlchemy</a></li>
  <li><a href="#4-update-objects">4. Update Objects</a>
    <ol>
      <li><a href="#sql-1">SQL</a></li>
      <li><a href="#flask-sqlalchemy-1">Flask SQLAlchemy</a></li>
    </ol>
  </li>
  <li><a href="#5-delete-objects">5. Delete Objects</a>
    <ol>
      <li><a href="#sql-2">SQL</a></li>
      <li><a href="#flask-sqlalchemy-2">Flask SQLAlchemy</a></li>
    </ol>
  </li>
  <li><a href="#6-challenge-problems">6. Challenge Problems</a></li>
</ol>

            </aside>
            <article>
                

    
        <h1>
            <a href="../assignments/">Assignments</a> > 
            Activity 6: Intro to SQLAlchemy
        </h1>
    
 
                <p>As stated on the <a href="https://www.sqlalchemy.org/" target="_blank">SQL Alchemy project page</a>: “SQLAlchemy is the Python SQL toolkit and Object Relational Mapper that gives application developers the full power and flexibility of SQL.” In other words, SQL Alchemy is a python abstraction that makes communication with databases easier. It is database agnostic, meaning that you use the same commands, regardless of whether you’re interacting with PostgreSQL, SQLite, MySQL, or some other relational database.</p>

<h2 id="set-up-todays-exercises">Set Up Today’s Exercises</h2>
<ol>
  <li>
    <p>Create an empty database  by opening your terminal / dos prompt and typing (you will need to type in your database password):</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> psql -U postgres
</code></pre></div>    </div>

    <p>Once you’re on the psql command prompt, create a new database called <code class="highlighter-rouge">orm_test</code> as follows:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">create</span> <span class="k">database</span> <span class="n">orm_test</span><span class="p">;</span>
</code></pre></div>    </div>

    <p>Once you get a “Database Created” message, exit <code class="highlighter-rouge">psql</code> by typing <code class="highlighter-rouge">\q</code></p>
  </li>
  <li>
    <p>Download today’s lecture files, unzip them, and save the <code class="highlighter-rouge">orm_introduction</code> folder in your <code class="highlighter-rouge">csci344/lectures</code> directory. <br /><br /><a class="nu-button" href="/spring2025/course-files/activities/orm-introduction.zip">ORM Sample Files  <i class="fas fa-download"></i></a></p>
  </li>
  <li>
    <p>Open VS Code</p>
  </li>
  <li>
    <p>From within the VS Code terminal, to your <code class="highlighter-rouge">lectures/orm-introduction</code> folder. Then, set up a virtual environment and install the dependencies as follows (depending on your operating system):</p>

    <p><strong>For Mac, Unix, Linux, or GitBash:</strong></p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> python3 <span class="nt">-m</span> venv <span class="nb">env
 source env</span>/bin/activate
 pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt    <span class="c"># install dependencies</span>
</code></pre></div>    </div>

    <p><strong>For Windows Powershell or Command Prompt:</strong></p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c"># create the virtual environment</span>
 py <span class="nt">-m</span> venv <span class="nb">env</span>  

 <span class="c"># run the activate.bat script as follows:</span>
 <span class="nb">env</span><span class="se">\S</span>cripts<span class="se">\a</span>ctivate

 <span class="c"># and finally, install the Python dependencies</span>
 py <span class="nt">-m</span> pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt
</code></pre></div>    </div>
  </li>
  <li>
    <p>Update your database connection string with your password. To do this, open in the <code class="highlighter-rouge">.env</code> file and edit the <code class="highlighter-rouge">DB_URL</code> string. So, instead of…</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> DB_URL=postgresql://postgres:12345@localhost/orm_test
</code></pre></div>    </div>

    <p>You will change it to…</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> DB_URL=postgresql://postgres:your_password@localhost/orm_test   # but replace your_password
</code></pre></div>    </div>
  </li>
  <li>
    <p>After updating your database connection string, run the database populate script from your command prompt (from within the <code class="highlighter-rouge">orm-introduction</code> folder).</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> python populate.py
</code></pre></div>    </div>
  </li>
  <li>
    <p>Finally, run your flask server as follows:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> flask run <span class="nt">--debug</span>

 <span class="c"># if you named your app something other than app.py (say, hello.py) type this:</span>
 <span class="c"># flask flask --app hello run --debug</span>
</code></pre></div>    </div>

    <p>You should see the following output:</p>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">*</span> Serving Flask app <span class="s2">"app.py"</span> <span class="o">(</span>lazy loading<span class="o">)</span>
 <span class="k">*</span> Environment: development
 <span class="k">*</span> Debug mode: on
 <span class="k">*</span> Running on http://127.0.0.1:5000/ <span class="o">(</span>Press CTRL+C to quit<span class="o">)</span>
 <span class="k">*</span> Restarting with <span class="nb">stat</span>
 <span class="k">*</span> Debugger is active!
 <span class="k">*</span> Debugger PIN: 273-580-071
</code></pre></div>    </div>

    <p>Navigate to <a href="http://127.0.0.1:5000/" target="_blank">http://127.0.0.1:5000/</a>, and you should see a screen that lists the exercises that you are to complete:</p>
  </li>
</ol>

<blockquote class="info">
  <h3 id="what-just-happened">What just happened?</h3>
  <p>In the intructions above, we created a new database, installed and configured our python files / libraries to interact with our database, populated our database, and are now running the flask server.</p>

  <p>This infrastructure will allow your users to query a database from their client code!</p>
</blockquote>

<h2 id="what-is-an-object-relational-mapping-orm">What is an Object Relational Mapping (ORM)?</h2>
<p>ORMs allow a programmer to associate user-defined Python classes with database tables, and instances of those classes (objects) with rows in their corresponding tables (<a href="https://docs.sqlalchemy.org/en/14/orm/tutorial.html" target="_blank">more on ORM here</a>). In other words, rather than writing SQL directly, you interact with SQL Alchemy “models” that issue SQL queries under-the-hood.</p>

<h3 id="post-model">Post Model</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Post</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>

    <span class="c1"># name of table I want to connect to:
</span>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">'posts'</span>

    <span class="c1"># reference to the columns with which I want the application
</span>    <span class="c1"># to interact:
</span>    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">image_url</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">String</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">caption</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">Text</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">alt_text</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">Text</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">pub_date</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="p">.</span><span class="n">utcnow</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="p">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">'users.id'</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s">'cascade'</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># read-only property for referencing User properties
</span>    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">relationship</span><span class="p">(</span><span class="s">'User'</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s">"posts"</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">comments</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">relationship</span><span class="p">(</span><span class="s">'Comment'</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="s">"all,delete-orphan"</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s">'select'</span><span class="p">,</span> 
        <span class="n">order_by</span><span class="o">=</span><span class="s">'Comment.pub_date'</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="n">db</span><span class="p">.</span><span class="n">backref</span><span class="p">(</span><span class="s">'posts'</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s">'joined'</span><span class="p">))</span>
    <span class="n">likes</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">relationship</span><span class="p">(</span><span class="s">'LikePost'</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="s">"all,delete-orphan"</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s">'select'</span><span class="p">,</span>
        <span class="n">order_by</span><span class="o">=</span><span class="s">'LikePost.timestamp'</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="n">db</span><span class="p">.</span><span class="n">backref</span><span class="p">(</span><span class="s">'posts'</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s">'joined'</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_url</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">caption</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">alt_text</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pub_date</span><span class="p">:</span><span class="n">datetime</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">image_url</span> <span class="o">=</span> <span class="n">image_url</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">caption</span> <span class="o">=</span> <span class="n">caption</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">alt_text</span> <span class="o">=</span> <span class="n">alt_text</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">pub_date</span> <span class="o">=</span> <span class="n">pub_date</span>
</code></pre></div></div>

<h3 id="post-table">Post Table</h3>
<p><img src="/spring2025/assets/images/activities/sql-alchemy/posts.png" class="large frame" /></p>

<p>With this <code class="highlighter-rouge">Post</code> model definition, I am able to create, read, update, and delete records from the <code class="highlighter-rouge">posts</code> table. Some examples of how you would perform each of these operations are listed below:</p>

<h3 id="tips-for-following-along">Tips for following along</h3>
<p>Please read the SQL Alchemy section carefully, and try executing some of the sample commands using the flask shell. To access the flask shell:</p>

<ol class="compact">
  <li>Open your Terminal / command prompt,</li>
  <li>Navigate to your <code class="highlighter-rouge">hw05</code> files,</li>
  <li>Make sure your virtual environment is activated, and</li>
  <li>Type <code class="highlighter-rouge">flask shell</code></li>
</ol>

<p>Within the <strong>flask shell</strong>, you can interact with any of the data models (described in more detail below).</p>

<h2 id="1-create-new-objects">1. Create New Objects</h2>

<p>Creating a Post resource:</p>

<h3 id="sql">SQL</h3>
<p>To create a new record in the <code class="highlighter-rouge">posts</code> table using SQL, you would issue this command:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">posts</span><span class="p">(</span><span class="n">image_url</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">caption</span><span class="p">,</span> <span class="n">alt_text</span><span class="p">,</span> <span class="n">pub_date</span><span class="p">)</span>
    <span class="k">VALUES</span><span class="p">(</span>
        <span class="s1">'https://picsum.photos/600/430?id=668'</span><span class="p">,</span> 
        <span class="mi">3</span><span class="p">,</span> 
        <span class="s1">'Some caption text'</span><span class="p">,</span>
        <span class="s1">'Some alt text'</span><span class="p">,</span>
        <span class="n">now</span><span class="p">()</span>
    <span class="p">)</span>
</code></pre></div></div>

<h3 id="flask-sqlalchemy">Flask SQLAlchemy</h3>
<p>In SQL Alchemy, you create a record just like you would create any object. The only difference is that you have to add and commit the object to the database session:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">models.post</span> <span class="kn">import</span> <span class="n">Post</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">db</span>

<span class="c1"># 1. Create:
</span><span class="n">new_post</span> <span class="o">=</span> <span class="n">Post</span><span class="p">(</span>
    <span class="n">image_url</span><span class="o">=</span><span class="s">'https://picsum.photos/600/430?id=668'</span><span class="p">,</span>
    <span class="n">user_id</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="c1"># must be a valid user_id or will throw an error
</span>    <span class="n">caption</span><span class="o">=</span><span class="s">'Some caption text'</span><span class="p">,</span>
    <span class="n">alt_text</span><span class="o">=</span><span class="s">'Some alt text'</span>
<span class="p">)</span>
<span class="n">db</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_post</span><span class="p">)</span>    <span class="c1"># issues the insert statement
</span><span class="n">db</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">commit</span><span class="p">()</span>         <span class="c1"># commits the change to the database 
</span></code></pre></div></div>

<p>Try running the above command using the flask shell (and don’t forget the import statement).</p>

<h2 id="2-simple-queries">2. Simple Queries</h2>
<p>Just like in SQL, querying operations can be complex, as you often want to filter, join, and aggregate data. You will be using the Flask SQL Alchemy library for simple queries (<a href="https://flask-sqlalchemy.palletsprojects.com/en/2.x/queries/" target="_blank">Flask SQL Alchemy documentation here</a>).</p>

<h3 id="retrieve-all-posts">Retrieve all posts</h3>

<p>Using SQL:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">posts</span><span class="p">;</span>
</code></pre></div></div>

<p>Using <strong>Flask SQLAlchemy</strong> via the flask shell:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">models.post</span> <span class="kn">import</span> <span class="n">Post</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">db</span>

<span class="c1"># get all of the posts:
</span><span class="n">posts</span> <span class="o">=</span> <span class="n">Post</span><span class="p">.</span><span class="n">query</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>

<span class="c1"># print posts:
</span><span class="k">print</span><span class="p">(</span><span class="n">posts</span><span class="p">)</span>

<span class="c1"># use loop to output specific post attributes: 
</span><span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">posts</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span>
        <span class="n">post</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="s">'|'</span><span class="p">,</span> 
        <span class="n">post</span><span class="p">.</span><span class="n">image_url</span><span class="p">,</span> <span class="s">'|'</span><span class="p">,</span> 
        <span class="n">post</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">username</span><span class="p">,</span> <span class="s">'| # comments:'</span><span class="p">,</span> 
        <span class="nb">len</span><span class="p">(</span><span class="n">post</span><span class="p">.</span><span class="n">comments</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></div>

<h3 id="retrieve-the-first-10-posts">Retrieve the first 10 posts</h3>

<p>Using SQL:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">posts</span> <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</code></pre></div></div>

<p>Using <strong>Flask SQLAlchemy</strong> via the flask shell:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">models.post</span> <span class="kn">import</span> <span class="n">Post</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">db</span>
<span class="n">posts</span> <span class="o">=</span> <span class="n">Post</span><span class="p">.</span><span class="n">query</span><span class="p">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">).</span><span class="nb">all</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="retrieve-all-the-posts-created-by-user-5">Retrieve all the posts created by user #5</h3>

<p>Using SQL:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">posts</span> <span class="k">WHERE</span> <span class="n">user_id</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</code></pre></div></div>

<p>Using <strong>Flask SQLAlchemy</strong> via the flask shell:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">models.post</span> <span class="kn">import</span> <span class="n">Post</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">db</span>
<span class="c1"># filter the posts (simple):
</span><span class="n">posts</span> <span class="o">=</span> <span class="n">Post</span><span class="p">.</span><span class="n">query</span><span class="p">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">5</span><span class="p">).</span><span class="nb">all</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="retrieve-all-the-posts-created-by-user-with-a-username-of-chad_marks">Retrieve all the posts created by user with a username of “chad_marks”</h3>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">posts</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">users</span> <span class="k">ON</span>
    <span class="n">posts</span><span class="p">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">users</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span> <span class="n">users</span><span class="p">.</span><span class="n">username</span> <span class="o">=</span> <span class="s1">'chad_marks'</span><span class="p">;</span>
</code></pre></div></div>

<p>Using <strong>Flask SQLAlchemy</strong> via the flask shell:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">models.post</span> <span class="kn">import</span> <span class="n">Post</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">db</span>
<span class="c1"># filter the posts (by attribute of a joined table):
</span><span class="n">posts</span> <span class="o">=</span> <span class="n">Post</span><span class="p">.</span><span class="n">query</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">Post</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">has</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s">'chad_marks'</span><span class="p">)).</span><span class="nb">all</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="retrieve-a-single-post-with-id--5">Retrieve a single post with id = 5</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">posts</span> <span class="k">where</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</code></pre></div></div>

<p>Using <strong>Flask SQL Alchemy</strong> via the flask shell:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">models.post</span> <span class="kn">import</span> <span class="n">Post</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">db</span>
<span class="c1"># get single post based on primary key (id column):
</span><span class="n">post</span> <span class="o">=</span> <span class="n">Post</span><span class="p">.</span><span class="n">query</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>

</code></pre></div></div>

<h3 id="other-cool-stuff-you-can-do-wsqlalchemy">Other cool stuff you can do w/SQLAlchemy</h3>
<p>With SQLAlchemy, you can also query related tables via foreign keys. For instance, in the code below, <code class="highlighter-rouge">post.user</code> queries the users table and <code class="highlighter-rouge">post.comments</code> queries the comments table:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">models.post</span> <span class="kn">import</span> <span class="n">Post</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">db</span>
<span class="c1"># get single post based on primary key (id column):
</span><span class="n">post</span> <span class="o">=</span> <span class="n">Post</span><span class="p">.</span><span class="n">query</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># get the user of a post (from the users table)
</span><span class="n">post</span><span class="p">.</span><span class="n">user</span> <span class="c1"># under the hood, queries the users table for the user_id associated with the post
</span>
<span class="c1"># get all of the comments on a post (from the comments table)
</span><span class="n">post</span><span class="p">.</span><span class="n">comments</span> <span class="c1"># under the hood, queries for all comments associated with the post
</span></code></pre></div></div>

<h2 id="3-advanced-queries-with-regular-sqlalchemy">3. Advanced Queries with <span class="emphasize">REGULAR</span> SQLAlchemy</h2>
<p>“Flask SQLAlchemy” also inherits from “SQLAlchemy,” so if you’re looking to execute more complex queries, consult the regular SQLAlchemy documentation (<a href="https://docs.sqlalchemy.org/en/14/orm/tutorial.html#common-filter-operators" target="_blank">SQL Alchemy documentation here</a>). Some samples of some more complex queries are shown below. Again, you are encouraged to run these commands for yourself using the flask shell:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">models.post</span> <span class="kn">import</span> <span class="n">Post</span>
<span class="kn">from</span> <span class="nn">models.user</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">models.comment</span> <span class="kn">import</span> <span class="n">Comment</span>
<span class="kn">from</span> <span class="nn">models.following</span> <span class="kn">import</span> <span class="n">Following</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">func</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">engine</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">session</span>

<span class="c1">##########################################################
# 1. query for substring matches using a "like" function #
##########################################################
</span><span class="n">posts</span> <span class="o">=</span> <span class="n">Post</span><span class="p">.</span><span class="n">query</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">Post</span><span class="p">.</span><span class="n">caption</span><span class="p">.</span><span class="n">ilike</span><span class="p">(</span><span class="s">'%tree%'</span><span class="p">)).</span><span class="nb">all</span><span class="p">()</span>
<span class="s">'''
-- analagous SQL query:
SELECT *
FROM posts 
LEFT OUTER JOIN users 
    AS users_1 ON users_1.id = posts.user_id 
WHERE posts.caption ILIKE '%tree%';
'''</span>

<span class="c1">##################
# 2. "in" clause #
##################
# give me all the posts that created by users 3, 4, or 5. 
</span><span class="n">posts</span> <span class="o">=</span> <span class="n">Post</span><span class="p">.</span><span class="n">query</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">Post</span><span class="p">.</span><span class="n">user_id</span><span class="p">.</span><span class="n">in_</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">])).</span><span class="nb">all</span><span class="p">()</span>
<span class="s">'''
-- analagous SQL query:
SELECT *
FROM posts 
LEFT OUTER JOIN users 
    AS users_1 ON users_1.id = posts.user_id 
WHERE posts.user_id IN (3, 4, 5);
'''</span>

<span class="c1">######################
# 3. "not in" clause #
######################
# give me all the posts that were NOT created by users 3, 4, or 5. 
</span><span class="n">posts</span> <span class="o">=</span> <span class="n">Post</span><span class="p">.</span><span class="n">query</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="o">~</span><span class="n">Post</span><span class="p">.</span><span class="n">user_id</span><span class="p">.</span><span class="n">in_</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">])).</span><span class="nb">all</span><span class="p">()</span>  
<span class="s">'''
-- analagous SQL query:
SELECT *
FROM posts 
LEFT OUTER JOIN users 
    AS users_1 ON users_1.id = posts.user_id 
WHERE posts.user_id NOT IN (3, 4, 5);
'''</span> 

<span class="c1">######################################################################
# 4. get all of the users in my feed (e.g., the users I'm following) #
######################################################################
</span><span class="n">current_user_id</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">following</span> <span class="o">=</span> <span class="n">Following</span><span class="p">.</span><span class="n">query</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">Following</span><span class="p">.</span><span class="n">user_id</span><span class="o">==</span><span class="n">current_user_id</span><span class="p">).</span><span class="nb">all</span><span class="p">()</span>
<span class="s">'''
-- analagous SQL query:
SELECT *
FROM following 
LEFT OUTER JOIN users 
    AS users_1 ON users_1.id = following.user_id 
LEFT OUTER JOIN users AS 
    users_2 ON users_2.id = following.following_id 
WHERE following.user_id = 1
'''</span>

<span class="n">following</span>

<span class="c1"># 4a. build a list of all of the User ids that the current user is following:
</span><span class="n">user_ids</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">following</span><span class="p">:</span>
    <span class="n">user_ids</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">following_id</span><span class="p">)</span>
<span class="n">user_ids</span>

<span class="c1"># 4b. or like this (using a list comprehension):
</span><span class="n">user_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">user_ids_tuples</span><span class="p">]</span>

<span class="c1">#################################################
# 5. Get all of the posts in a user's news feed #
#################################################
# 5a. build a list of authorized users (same as #4):
</span><span class="n">current_user_id</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">following</span> <span class="o">=</span> <span class="n">Following</span><span class="p">.</span><span class="n">query</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">Following</span><span class="p">.</span><span class="n">user_id</span><span class="o">==</span><span class="n">current_user_id</span><span class="p">).</span><span class="nb">all</span><span class="p">()</span>
<span class="n">user_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">user_ids_tuples</span><span class="p">]</span>

<span class="c1"># 5.b Add the current user to this user_ids list
# b/c a user should also be able to see their own posts
</span><span class="n">user_ids</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_user_id</span><span class="p">)</span>

<span class="c1"># 5.c. Now use the "in" query noted in #2 above to get a list
# of authorized posts:
</span><span class="n">posts</span> <span class="o">=</span> <span class="n">Post</span><span class="p">.</span><span class="n">query</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">Post</span><span class="p">.</span><span class="n">user_id</span><span class="p">.</span><span class="n">in_</span><span class="p">(</span><span class="n">user_ids</span><span class="p">)).</span><span class="nb">all</span><span class="p">()</span>
<span class="s">'''
-- analagous SQL query:
SELECT *
FROM posts 
LEFT OUTER JOIN users 
    AS users_1 ON users_1.id = posts.user_id 
WHERE posts.user_id IN (4, 6, 8, 12, 16, 18, 20, 21, 22, 23, 1);
'''</span>

<span class="n">posts</span>


<span class="c1">#######################
# 6. Join: two tables #
#######################
# Sample query: "Give me back the Post and the User object
# for posts that were authored by someone with the string 'ar'
# in their username":
</span><span class="n">statement</span> <span class="o">=</span> 
<span class="n">posts</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">session</span>
        <span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="n">User</span><span class="p">)</span>
        <span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">User</span><span class="p">.</span><span class="nb">id</span><span class="o">==</span><span class="n">Post</span><span class="p">.</span><span class="n">user_id</span><span class="p">)</span>
        <span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">User</span><span class="p">.</span><span class="n">username</span><span class="p">.</span><span class="n">ilike</span><span class="p">(</span><span class="s">'%ar%'</span><span class="p">)).</span><span class="nb">all</span><span class="p">()</span>
<span class="p">)</span>

<span class="s">'''
-- analagous SQL query:
SELECT *
FROM posts 
JOIN users ON 
    users.id = posts.user_id 
LEFT OUTER JOIN users AS users_1 
    ON users_1.id = posts.user_id 
WHERE users.username ILIKE '%ar%';
'''</span>

<span class="c1">#########################
# 7. Join: three tables #
#########################
# "List the post, author, and number of comments per post":
# Note that an "outer join" is needed on the comments table in the
# event that a post has no comments.
</span><span class="n">posts</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">session</span>
        <span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="n">Post</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="n">User</span><span class="p">.</span><span class="n">username</span><span class="p">,</span> <span class="n">func</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">Comment</span><span class="p">.</span><span class="nb">id</span><span class="p">))</span>
        <span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">User</span><span class="p">.</span><span class="nb">id</span><span class="o">==</span><span class="n">Post</span><span class="p">.</span><span class="n">user_id</span><span class="p">)</span>
        <span class="p">.</span><span class="n">outerjoin</span><span class="p">(</span><span class="n">Comment</span><span class="p">,</span> <span class="n">Post</span><span class="p">.</span><span class="nb">id</span><span class="o">==</span><span class="n">Comment</span><span class="p">.</span><span class="n">post_id</span><span class="p">)</span> 
        <span class="p">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Post</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="n">User</span><span class="p">.</span><span class="n">username</span><span class="p">)</span>
        <span class="p">.</span><span class="nb">all</span><span class="p">()</span>
<span class="p">)</span>
<span class="s">'''
-- analagous SQL query:
SELECT posts.id AS posts_id, users.username AS users_username, count(comments.id) AS count_1 
FROM posts 
JOIN users ON 
    users.id = posts.user_id 
LEFT OUTER JOIN comments ON 
    posts.id = comments.post_id 
GROUP BY posts.id, users.username;
'''</span>

<span class="c1">############################################
# 8. You can also issue raw SQL statements #
############################################
</span>
<span class="c1"># Raw SQL query example for more complex queries...
# The query below returns the post_id, username, # of comments, # of likes for every post:
</span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">text</span>

<span class="n">sql</span> <span class="o">=</span> <span class="s">'''
SELECT posts.id AS post_id, users.username AS username,  
    count(distinct comments.id) AS comment_count,
    count(distinct likes_posts.id) AS likes_count
FROM posts 
JOIN users ON 
    users.id = posts.user_id 
LEFT OUTER JOIN comments ON 
    posts.id = comments.post_id 
LEFT OUTER JOIN likes_posts ON 
    posts.id = likes_posts.post_id 
GROUP BY posts.id, users.username;
'''</span>
<span class="k">with</span> <span class="n">db</span><span class="p">.</span><span class="n">engine</span><span class="p">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">posts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">conn</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">sql</span><span class="p">)))</span>
</code></pre></div></div>

<h2 id="4-update-objects">4. Update Objects</h2>
<p>Updating a Post resource:</p>

<h3 id="sql-1">SQL</h3>
<p>To update one or more resources in SQL, you need to specify:</p>

<ol class="compact">
  <li>The table,</li>
  <li>The columns you would like to change (and their new values), and</li>
  <li>A WHERE clause indicating which records you’d like to change</li>
</ol>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">UPDATE</span> <span class="n">posts</span> 
<span class="k">SET</span> <span class="n">image_url</span> <span class="o">=</span> <span class="s1">'https://picsum.photos/600/430?id=443'</span><span class="p">,</span>
    <span class="n">caption</span> <span class="o">=</span> <span class="s1">'Updated caption'</span><span class="p">,</span>
    <span class="n">alt_text</span> <span class="o">=</span> <span class="s1">'Updated alt text'</span>
<span class="k">WHERE</span> <span class="n">id</span><span class="o">=</span><span class="mi">6</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="flask-sqlalchemy-1">Flask SQLAlchemy</h3>
<p>In SQLAlchemy, you update the object (like you would any Python object) and then commit the change to the database:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">models.post</span> <span class="kn">import</span> <span class="n">Post</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">db</span>

<span class="n">post</span> <span class="o">=</span> <span class="n">Post</span><span class="p">.</span><span class="n">query</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="n">post</span><span class="p">.</span><span class="n">image_url</span> <span class="o">=</span> <span class="s">'https://picsum.photos/600/430?id=443'</span>
<span class="n">post</span><span class="p">.</span><span class="n">caption</span> <span class="o">=</span> <span class="s">'Updated caption'</span>
<span class="n">post</span><span class="p">.</span><span class="n">alt_text</span> <span class="o">=</span> <span class="s">'Updated alt text'</span>

<span class="c1"># commit changes:
</span><span class="n">db</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">commit</span><span class="p">()</span> 
</code></pre></div></div>

<h2 id="5-delete-objects">5. Delete Objects</h2>
<p>Deleting a Post resource:</p>

<h3 id="sql-2">SQL</h3>
<p>To delete one or more records in a table using SQL, 
you specify the table and the WHERE clause:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">posts</span> <span class="k">WHERE</span> <span class="n">id</span><span class="o">=</span><span class="mi">5</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="flask-sqlalchemy-2">Flask SQLAlchemy</h3>
<p>In SQLAlchemy, you specify the query matching the items you want to delete, and then invoke the <code class="highlighter-rouge">delete()</code> method:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">models.post</span> <span class="kn">import</span> <span class="n">Post</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">db</span>

<span class="n">Post</span><span class="p">.</span><span class="n">query</span><span class="p">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">5</span><span class="p">).</span><span class="n">delete</span><span class="p">()</span>
<span class="n">db</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">commit</span><span class="p">()</span>

<span class="n">post</span> <span class="o">=</span> <span class="n">Post</span><span class="p">.</span><span class="n">query</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="c1"># should return None
</span></code></pre></div></div>

<h2 id="6-challenge-problems">6. Challenge Problems</h2>

<ol class="compact">
  <li>Write a query that shows all of the posts liked by User #3</li>
  <li>Write a query that shows all of the posts bookmarked by User #3</li>
  <li>Write a query that shows all of the posts in User #3’s feed (we’ve already gone over this, but see if you can write it again from scratch – as you’ll need to do it for HW7)</li>
  <li>Write a query that creates a new Like entry reflecting that User #3 likes Post #10. Verify that it works (see #1).</li>
  <li>Write a query that creates a new Bookmark entry reflecting that User #3 bookmarked Post #10</li>
  <li>Delete the new Bookmark entry you just created.</li>
</ol>

<p>Nice job issuing those SQL Alchemy queries! It just takes some practice to get the hang of interacting with your database using the ORM syntax.</p>

            </article>  
        </main>
        <footer>
            <p>    
                Department of Computer Science, UNC Asheville
            </p>
        </footer>
        
            <script type="text/javascript" src="/spring2025/assets/js/main.js"></script>
    
    <!-- <script>
        //little bit of a hack:
        const scrollLeft = () => {
            //console.log('scrollLeft');
            document.documentElement.scrollLeft = 0;
        };
        setTimeout(scrollLeft, 100);
    </script> -->
        <script type="text/javascript" src="/spring2025/assets/js/expandable.js"></script>
    </body>
</html>